<%@ page contentType="text/html;charset=utf-8" %>
	<html>
	<%@ include file="/WEB-INF/common/include.jsp" %>

		<head>
			<title></title>
			<link rel="stylesheet" href="../../../../css/inputbox/line6.css">
			<script>

				window.onload = function () {
					policyDetailDlgInit();

					initDataGrid20($('#orderPolicyList'));

					$('#qorderstratdate').datebox('setValue', getSevenDaysAgo());

					disComBox($("#sealchannel"), "channel", null);
					disComBox($('#qinsorgancode'), "insorgancode", null);

					displayCombox($('#qstate'), null, "/jsondata/order/orderstate.json", "dd_key", "dd_value");
				}

				function aftercodeselect(comboxid) {
					if (comboxid.attr("id") == "qinsorgancode") {
						var tParam = new Object();
						var codes = comboxid.combobox('getValues');


						// 判断是否为字母（包括大小写）
						const isLetter = /^[A-Za-z]+$/.test(codes[0]);
						// 判断是否为汉字
						const isChinese = /^[\u4e00-\u9fa5]+$/.test(codes[0]);
						if (isChinese) {
							codes.splice(0, 1); // 从索引 0 开始删除 1 个元素
							$("#qinsorgancode").combobox('setValue', codes);
						}



						var ic = "";
						ic = codes.join(",");
						tParam.insorgancode = ic;
						var tturl1 = "policy/getRiskListin.do";

						displayCombox($('#qriskcode'), tParam, tturl1, "dd_key", "dd_value");
					}
				}

				function selectone() {

				}

				function orderquery() {
					var tturl = "orderPolicy/getOrderPollicyList.do";

					var tParam = new Object();
					//todo  还差加条件
					tParam.orderstratdate = $('#qorderstratdate').datebox("getValue");
					tParam.orderenddate = $('#qorderenddate').datebox("getValue");
					tParam.orderid = $('#qorderid').val();
					tParam.state = $('#qstate').combobox('getValue');

					tParam.username = $('#qusername').val();
					tParam.insorganname = $('#qinsorganname').val();

					var codes = $('#qinsorgancode').combobox('getValues');
					var ic = "";
					ic = codes.join(",");
					tParam.insorgancode = ic;

					var codess = $('#qriskcode').combobox('getValues');
					var icc = "";
					icc = codess.join(",");
					tParam.riskcode = icc;


					tParam.riskname = $('#qriskname').val();
					tParam.cusname = $('#qcusname').val();
					tParam.cusmobile = $('#qcusmobile').val();
					tParam.sealchannel = $("#sealchannel").combobox("getValue");

					displayDataGrid20($('#orderPolicyList'), tParam, tturl);

					clearCarData();
				}

				function saveSuss() {
					$('#orderPolicyList').datagrid('reload');
				}

				function queryPolicyInfo(val, row, index) {
					return '<a href="#" onclick="openDlg(' + index + ')">查看详情</a>';
				}

				function openDlg(index) {
					var rows = $('#orderPolicyList').datagrid('getRows');//获取所有当前加载的数据行
					var row = rows[index];

					//alert(row.agentcom);

					dispolicyDetailDlg(row);
				}

				function disStateName(val, row, index) {
					if (row.state == '70' || row.state == '72' || row.state == '76') {
						return '生效前退款'
					}
					else {
						return row.statename;
					}
				}

				function dis_payurl(val, row, index) {

					if (val != null && val !== '') {
						return '<a href="#" onclick="openPayurl(' + index + ')"   style="color: blue; cursor: pointer;">复制</a>';
					} else if (row.sealchannel == '13' && row.state == "20") {
						return '<a href="#" onclick="openPayurl(' + index + ')" style="color: blue; cursor: pointer;">复制</a>';
					} else {
						return ''
					}
				}




				function openPayurl(index) {
					var rows = $('#orderPolicyList').datagrid('getRows'); //获取所有当前加载的数据行
					var row = rows[index];
					if (row.sealchannel == '13' && row.state != '40') {
						// 如果已经请求过，直接返回 payurl
						if (row.payurl && row.payurl !== '加载中...') {
							return row.payurl;
						}
						// 标记为加载中，避免重复请求
						if (row.payurl !== '加载中...') {
							row.payurl = '加载中...';
							var tParam = {
								orderid: row.orderid,
								sealchannel: row.sealchannel
							};
							var queryurl = "policy/gethzpayurl.do";
							setTimeout(() => {
								ajaxdeal(queryurl, tParam, function (data) {
									var newPayurl = data.payurl || '';
									if (data.payurl) {
										copyText(newPayurl)
									} else {
										$.messager.alert('消息提示', '复制失败，暂无链接', 'info');
									}
								}, null);
							}, 0);
						}
						return '加载中...';
					} else {
						copyText(row.payurl);
					}
				}

				function dis_payment(val, row, index) {
					if (val === null || val === undefined || val === '') {
						return ''
					} else {
						return Number(val).toFixed(2)
					}
				}



				function dispayendtime(val, row, index) {
					if (val === null || val === undefined || val === '') {
						return ""
					} else if (row.state == '20') {
						// 把字符串转换成 Date 对象（兼容性好）
						var valDate = new Date(val.replace(' ', 'T')); // 转成 ISO 格式方便解析
						var now = new Date();

						if (valDate > now) {
							return val
						} else {
							return ""
						}
					}
				}



			</script>

		</head>
		<%@ include file="/WEB-INF/jsp/admin/policy/policyDetailDlg.jsp" %>

			<body>
				<div style="margin-left:0%">
					<table class="common">
						<tr>
							<td class="reprot_title">
								订单起期
							</td>
							<td class="report_common">
								<input class="easyui-datebox" style="width: 90%" id="qorderstratdate"
									name="qorderstratdate" notnull="出单起期">
							</td>

							<td class="reprot_title">
								订单止期
							</td>
							<td class="report_common">
								<input class="easyui-datebox" style="width: 90%" id="qorderenddate" name="qorderenddate"
									notnull="出单止期">
							</td>

							<td class="reprot_title">
								订单号
							</td>
							<td class="report_common">
								<input class="txt" name="qorderid" id="qorderid">
							</td>

							<td class="reprot_title">
								订单状态
							</td>
							<td class="report_common">
								<select class="easyui-combobox" style="width:90%" panelHeight="auto" name="qstate"
									id="qstate">
								</select>
							</td>

							<td class="reprot_title">签约渠道</td>
							<td class="reprot_common">
								<select class="easyui-combobox" style="width: 160%" name="sealchannel"
									id="sealchannel"></select>
							</td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
						<tr>
							<td class="reprot_title">
								业务员姓名
							</td>
							<td class="report_common">
								<input class="txt" name="qusername" id="qusername">
							</td>

							<!-- 
							<td class="reprot_title">
								保险公司
							</td>
							<td class="report_common">
								<input class="txt" name="qinsorganname" id="qinsorganname">
							</td>

							<td class="reprot_title">
								险种名称
							</td>
							<td class="report_common">
								<input class="txt" name="qriskname" id="qriskname">
							</td> -->



							<td class="reprot_title">
								保险公司
							</td>
							<td class="report_common">
								<input class="easyui-combobox" id="qinsorgancode" style="width:90%" name="qinsorgancode"
									data-options="valueField:'id',textField:'text',multiple:true">
							</td>

							<td class="reprot_title">
								险种名称
							</td>
							<td class="report_common">
								<input class="easyui-combobox" id="qriskcode" style="width:90%" name="qriskcode"
									data-options="valueField:'id',textField:'text',multiple:true">
							</td>














							<td class="reprot_title">
								客户姓名
							</td>
							<td class="report_common">
								<input class="txt" name="qcusname" id="qcusname">
							</td>

							<td class="reprot_title">
								电话号码
							</td>
							<td class="report_common">
								<input class="txt" name="qcusmobile" id="qcusmobile">
							</td>

							<td></td>
							<td></td>
						</tr>
					</table>
					<br>
					<a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" id="orderquery"
						onclick="orderquery()">查询</a>
					<br>
					<br>
					<table id="orderPolicyList" class="easyui-datagrid" title="订单信息" style="width:auto;height:auto"
						data-options="rownumbers:true,singleSelect:true,pagination:true,onClickRow: selectone">
						<thead>
							<tr>
								<th data-options="field:'ordertime',width:125">订单日期</th>
								<!-- <th data-options="field:'organ04name',width:70">所属营业部</th>
			<th data-options="field:'teamname',width:100">所属团队</th>
			<th data-options="field:'reusername',width:70">所属业务员</th> -->
								<th data-options="field:'orderid',width:160">订单号</th>
								<th data-options="field:'policystate',width:60,formatter:disStateName">订单状态</th>
								<th data-options="field:'payurl',width:60,formatter:dis_payurl">支付链接</th>

								<th data-options="field:'payendtime',width:125,formatter:dispayendtime">支付截止时间</th>
								<th data-options="field:'payment',width:80,formatter:dis_payment" hidden>
									支付金额</th>
								<th data-options="field:'payerrormsg',width:120" hidden>支付失败原因</th>

								<th data-options="field:'insorganname',width:80">保险公司</th>
								<th data-options="field:'riskname',width:160">险种名称</th>
								<th data-options="field:'appname',width:70">投保人姓名</th>
								<!-- <th data-options="field:'appprovincename',width:70">投保人所在省</th> -->

								<th
									data-options="field:'appprovincename',width:70,formatter:function(value,row,index){return (value == null || value === '') ? (row.appprovince || '') : value;}">
									投保人所在省</th>

								<!-- <th data-options="field:'appcityname',width:70">投保人所在市</th> -->
								<th
									data-options="field:'appcityname',width:70,formatter:function(value,row,index){return (value == null || value === '') ? (row.appcity || '') : value;}">
									投保人所在市</th>

								<th data-options="field:'insname',width:70">被保人姓名</th>
								<th data-options="field:'payintvvalue',width:60">缴费方式</th>
								<th data-options="field:'payendyearvalue',width:60">缴费年期</th>
								<th data-options="field:'insuyearvalue',width:60">保障期限</th>
								<th data-options="field:'prem',width:80">保费</th>
								<!-- <th data-options="field:'_operate',width:60,formatter:queryPolicyInfo">查看详情</th> -->
							</tr>
						</thead>
					</table>
					<br>
					<br>
				</div>
			</body>

	</html>